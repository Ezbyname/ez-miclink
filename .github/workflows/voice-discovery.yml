name: Voice Effect Discovery

on:
  # Run every 3 days at 9 AM UTC (11 AM Israel time)
  schedule:
    - cron: '0 9 */3 * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  discover-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate Discovery Report
        id: discovery
        run: |
          REPORT_DATE=$(date +%Y%m%d)
          REPORT_FILE="VOICE_DISCOVERY_${REPORT_DATE}.md"

          echo "# Voice Effect Discovery Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Date:** $(date +%Y-%m-%d)" >> $REPORT_FILE
          echo "**Generated by:** Automated Discovery Agent" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## ðŸ”¥ Top Trending Voice Effects" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "### 1. Anime Voice Filter" >> $REPORT_FILE
          echo "**Popularity:** â­â­â­â­â­ (Very High)" >> $REPORT_FILE
          echo "**Difficulty:** ðŸŸ¡ Medium" >> $REPORT_FILE
          echo "**Implementation Time:** 2-3 hours" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**DSP Specs:**" >> $REPORT_FILE
          echo "- Pitch Shift: +5 semitones" >> $REPORT_FILE
          echo "- Formant Shift: +15%" >> $REPORT_FILE
          echo "- EQ Boost: 3-8kHz (+4dB)" >> $REPORT_FILE
          echo "- Compression: 3:1 ratio" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Why it's trending:** TikTok #animefilter has 2.4M posts" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## ðŸ’¡ Quick Action Items" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "1. Review this report" >> $REPORT_FILE
          echo "2. Select 1-2 effects to implement" >> $REPORT_FILE
          echo "3. Run: \`/create-voice-effect [effect-name]\`" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "*This report will be replaced with AI agent discovery once Claude API is integrated*" >> $REPORT_FILE

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "report_date=$REPORT_DATE" >> $GITHUB_OUTPUT

      - name: Send Email with Report (Python)
        run: |
          echo "Sending email via Python SMTP..."
          python3 .github/workflows/send-email.py \
            "${{ steps.discovery.outputs.report_file }}" \
            "${{ secrets.SENDER_EMAIL }}" \
            "${{ secrets.SENDER_APP_PASSWORD }}"

      - name: Commit Report to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ steps.discovery.outputs.report_file }}
          git commit -m "docs: Add voice discovery report ${{ steps.discovery.outputs.report_date }}" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Summary
        run: |
          echo "âœ… Voice discovery completed!"
          echo "ðŸ“§ Email sent to: yahalom.assets@gmail.com"
          echo "ðŸ“„ Report: ${{ steps.discovery.outputs.report_file }}"
          echo "ðŸ“… Next run: $(date -d '+3 days' +%Y-%m-%d)"

name: Voice Effect Discovery

on:
  # Run every 3 days at 9 AM UTC (11 AM Israel time)
  schedule:
    - cron: '0 9 */3 * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  discover-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate Discovery Report
        id: discovery
        run: |
          REPORT_DATE=$(date +%Y%m%d)
          REPORT_FILE="VOICE_DISCOVERY_${REPORT_DATE}.md"

          echo "# Voice Effect Discovery Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Date:** $(date +%Y-%m-%d)" >> $REPORT_FILE
          echo "**Generated by:** Automated Discovery Agent" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## üî• Top Trending Voice Effects" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "### 1. Anime Voice Filter" >> $REPORT_FILE
          echo "**Popularity:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Very High)" >> $REPORT_FILE
          echo "**Difficulty:** üü° Medium" >> $REPORT_FILE
          echo "**Implementation Time:** 2-3 hours" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**DSP Specs:**" >> $REPORT_FILE
          echo "- Pitch Shift: +5 semitones" >> $REPORT_FILE
          echo "- Formant Shift: +15%" >> $REPORT_FILE
          echo "- EQ Boost: 3-8kHz (+4dB)" >> $REPORT_FILE
          echo "- Compression: 3:1 ratio" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Why it's trending:** TikTok #animefilter has 2.4M posts" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## üí° Quick Action Items" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "1. Review this report" >> $REPORT_FILE
          echo "2. Select 1-2 effects to implement" >> $REPORT_FILE
          echo "3. Run: \`/create-voice-effect [effect-name]\`" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "*This report will be replaced with AI agent discovery once Claude API is integrated*" >> $REPORT_FILE

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "report_date=$REPORT_DATE" >> $GITHUB_OUTPUT

      - name: Commit Report to Repository
        continue-on-error: true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ steps.discovery.outputs.report_file }} || true
          git commit -m "docs: Add voice discovery report ${{ steps.discovery.outputs.report_date }}" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Create GitHub Issue with Report Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFile = '${{ steps.discovery.outputs.report_file }}';
            const reportContent = fs.readFileSync(reportFile, 'utf8');

            const issueBody = `## üé§ Voice Effect Discovery Report

            **Date:** ${{ steps.discovery.outputs.report_date }}
            **Report File:** [\`${reportFile}\`](https://github.com/${{ github.repository }}/blob/main/${reportFile})

            ---

            ## üî• Top Trending Effects

            1. ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê **Anime Voice Filter** (Very High Priority)
            2. ‚≠ê‚≠ê‚≠ê‚≠ê **Demon/Devil Voice** (Easy Implementation)
            3. ‚≠ê‚≠ê‚≠ê‚≠ê **Auto-Tune Effect** (High Demand)
            4. ‚≠ê‚≠ê‚≠ê **Ghost Voice** (Quick Win)
            5. ‚≠ê‚≠ê‚≠ê **Baby Voice** (Very Easy)

            ---

            ## üí° Quick Action Items

            1. ‚úÖ Review the [full report](https://github.com/${{ github.repository }}/blob/main/${reportFile})
            2. ‚úÖ Select 1-2 effects to implement
            3. ‚úÖ Run: \`/create-voice-effect [effect-name]\`

            ---

            ## üìä Full Report Preview

            <details>
            <summary>Click to expand full report</summary>

            \`\`\`markdown
            ${reportContent}
            \`\`\`

            </details>

            ---

            **Next Discovery:** 3 days from now

            ü§ñ _Automated by Voice Discovery Bot_`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üé§ Voice Effect Discovery - ${{ steps.discovery.outputs.report_date }}',
              body: issueBody,
              labels: ['voice-discovery', 'automation', 'discovered-effects']
            });

      - name: Summary
        run: |
          echo "‚úÖ Voice discovery completed!"
          echo "üìÑ Report: ${{ steps.discovery.outputs.report_file }}"
          echo "üìù GitHub Issue created with report summary"
          echo "üìÖ Next run: 3 days from now"
